<head th:replace="fragments_others_head2" :: head></head>
<body>
	<div id="layout-wrapper">
		<div th:replace="fragments_others_header2" :: header></div>
		<div th:replace="fragments_others_menu" :: menu1></div>
		<div class="main-content">
			<div class="page-content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-12">
							<div
								class="page-title-box d-sm-flex align-items-center justify-content-between">
								<h4 class="mb-sm-0"></h4>
								<div class="page-title-right">
									<ol class="breadcrumb m-0">
										<li class="breadcrumb-item"><a
											href="javascript: void(0);">Dash board</a></li>
										<li class="breadcrumb-item active">Update License</li>
									</ol>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-12">
							<div class="card">
								<div class="card-header bg-primary pb-2 pt-2">
									<div class="d-flex justify-content-between">
										<h4 class="card-title text-white mb-0 pt-2">Query Builder</h4>
										<button type="button"
													class="btn btn-success text-center right ms-auto nexttab nexttab QueryLogs"
													data-nexttab="pills-experience-tab" id="sendOtpTrnButton">Query Logs
													
												</button>
									</div>
								</div>
								<div class="mt-1 p-4 m-4">
									<div>

										<form class="row g-3 needs-validation" novalidate
											id="sendOtpTrnForm">
											<div>
												<label class="form-label" for="des-info-description-input">Query
													Builder :: ::</label>
												<textarea class="form-control quryString"
													placeholder="Enter Description"
													id="des-info-description-input" rows="7" required></textarea>
											</div>

											<div class="d-flex align-items-start gap-3 mt-2 mb-4">
												<button type="button"
													class="btn btn-primary btn-label right ms-auto nexttab nexttab"
													data-nexttab="pills-experience-tab" id="sendOtpTrnButt">
													<i
														class="ri-arrow-right-line label-icon align-middle fs-16 ms-2 aadhaarId "
														th:value="${usersRoleMapping.aadhaarId}"></i>Submit
												</button>


											</div>
											<div class="table-responsive">
											<table id="resultTable" class="table table-bordered table-striped table-responsive">

											</table>
											</div>

										</form>


									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>



			<!-- OTP Popup -->
			<div class="modal fade" id="otpPopupP1" tabindex="-1" role="dialog"
				aria-labelledby="exampleModalCenterTitle" aria-hidden="true"
				data-backdrop="static">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header bg-primary">
							<h5 class="modal-title text-white" id="exampleModalLongTitle"
								th:value="${usersRoleMapping.aadhaarId}"
								th:text="${#strings.repeat('X', usersRoleMapping.aadhaarId.length() - 4) + #strings.substring(usersRoleMapping.aadhaarId, usersRoleMapping.aadhaarId.length() - 4)}"></h5>
							<button type="button" class="close" data-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">

							<form id="formOtp">

								<div class="row">
									<div class="col-sm-12">
										<div class="popupbox11">
											<input type="checkbox" id="agree1" name="agree1" value="Bike">
											<label for="agree1"> I hereby state that i have no
												objection in authenticating myself with AADHAAR based
												authentication system and consent to providing my AADHAAR
												Number, and OTP for AADHAAR based Authentication. I also
												give my explicit consent for accessing the mobile number and
												email address from AADHAAR System. </label>
										</div>
										<div class="otpinputbox1">
											<input type="text" id="otp" name="otp" maxlength="6"
												style="display: none;" placeholder="OTP (Time-Based OTP)">
											<label class="left10minutes" style="display: none;">Note
												: AADHAAR OTP will be valid only for 10 minutes.</label><br> <label
												class="opt2minutes" style="display: none;">Resend
												OTP <span class="otp-countdown" id="timer-countdown">02:00</span>
											</label>
										</div>
									</div>
									<div class="flexbuttonOTP">
										<button type="button" class="btn btn-primary" id="sendOTP1"
											disabled>Send OTP</button>
										<button type="button" class="btn btn-primary"
											id="OTPvalidatebtn" style="display: none;">Validate
											OTP</button>
										<button type="button" class="btn btn-primary" id="resentOTP"
											style="display: none;">ReSend OTP</button>
										<button type="button" class="btn btn-primary cancel"
											data-dismiss="modal">Cancel</button>
										<input type="text" id="txn" name="txn" style="display: none;">
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<!--  successfully Verified OTP -->
			<!-- OTP Popup -->
			<div class="modal fade" id="optverifedsuccessfully" tabindex="-1"
				role="dialog" aria-labelledby="exampleModalCenterTitle"
				aria-hidden="true" data-backdrop="static">
				<div class="modal-dialog modal-dialog-centered" role="document">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="exampleModalLongTitle">OTP
								Verified!</h5>
							<button type="button" class="closeModel" data-dismiss="modal"
								aria-label="Close">
								<span aria-hidden="true">&times;</span>
							</button>
						</div>
						<div class="modal-body">

							<form>
								<div class="row">
									<div class="col-sm-12">
										<div class="popupbox11">
											<p class="text-success" id="#OTPVerifiedMsg">Query
												Executed Successfully.</p>
										</div>

									</div>

								</div>
							</form>
						</div>
					</div>
				</div>
			</div>
			<!-- Javascript files-->
			
			<div class="modal fade" id="throwError" tabindex="-1"
			role="dialog" aria-labelledby="exampleModalCenterTitle"
			aria-hidden="true" data-backdrop="static">
			<div class="modal-dialog modal-dialog-centered" role="document">
				<div class="modal-content">
					<div class="modal-header">
					<h5 class="modal-title" id="exampleModalLongTitle">Error Message</h5>
						<button type="button" class="closeModel1" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">

						<form>
							<div class="row">
								<div class="col-sm-12">
									<div class="popupbox11">
										<p class="text-success" id="#OTPVerifiedMsg">Table or view does not exist</p>
									</div>

								</div>

							</div>
						</form>
					</div>
				</div>
			</div>
		</div>


<!-- new code added -->
<div class="modal fade" id="throwError2" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Error Message</h5>
                <button type="button" class="closeModel1" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="popupbox11">
                                <p class="text-success" id="errorPopupMessage">Table or view does not exist</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<div class="modal hide fade" id="QueryLogs" tabindex="-1" role="dialog"
			aria-labelledby="exampleModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-fullscreen" role="document">
				<div class="modal-content">
					<div class="modal-header bg-primary">
						<h5 class="modal-title text-white" id="exampleModalLabel"></h5>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div class="table-responsive table-card1 mt-1 mb-1">
							<div class="table-responsive table-card1 mt-4 mb-1">
								<table id="table5" class="table table-striped"
									style="width: 100%">
									<thead class="alert-info">
										<tr>
											<th>SSO ID</th>
											<th>AADHAAR ID</th>
											<th>IP</th>
											<th>QUERY</th>
											<th>EXECUTION DATE</th>
											<th>STATUS</th>
											<th>TRANSACTION ID</th>
										 </tr>
									</thead>
								    <tbody id="table2body">

									</tbody>
									<tfoot class="alert-info">
										<tr>
											<th>SSO ID</th>
											<th>AADHAAR ID</th>
											<th>IP</th>
											<th>QUERY</th>
											<th>EXECUTION DATE</th>
											<th>STATUS</th>
											<th>TRANSACTION ID</th>
										 </tr>
									</tfoot>
								</table>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		`


		</div>
</body>
<script src="assets/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="assets/libs/feather-icons/feather.min.js"></script>
<script type='text/javascript'
	src='assets/libs/flatpickr/flatpickr.min.js'></script>
<script src="assets/js/jquery-3.5.1.js"></script>
<script src="assets/js/jquery.dataTables.min.js"></script>
<script src="assets/js/dataTables.bootstrap5.min.js"></script>
<script type="text/javascript"
	src="assets/js/dataTables.fixedHeader.min.js"></script>
<script type="text/javascript" src="assets/js/dataTables.buttons.min.js"></script>
<script type="text/javascript" src="assets/js/jszip.min.js"></script>
<script type="text/javascript" src="assets/js/buttons.html5.min.js"></script>
<script src="assets/js/app.js"></script>


<!-- new code added -->
<script>
    $(document).ready(function() {
        var errorMessage = "[[${errorMessage}]]"; // Get the error message from the model

        if (errorMessage) {
            // Display the error message in the popup
            $("#errorPopupMessage").text(errorMessage);
            $('#throwError2').modal('show');
        }
    });
</script>




<script>
	var table = '';
    $('#sendOtpTrnButt').click(function() {
    	var uuid = $(".aadhaarId").attr('value');
        var queryString = $('.quryString').val();
        var convertedToUpperCase = queryString.toUpperCase();
        if (convertedToUpperCase.includes("ASA_REQUEST") || convertedToUpperCase.includes("ASA_REQUEST_BKP") || convertedToUpperCase.includes("ASA_REQUEST_REMOVED")) {
            alert("This query is not allowed here.");
            return;
        } else if (convertedToUpperCase.includes("AUA_REQUEST") || convertedToUpperCase.includes("AUA_REQUEST_BKP") || convertedToUpperCase.includes("AUA_REQUEST_REMOVED")) {
            alert("This query is not allowed here.");
            return;
        } else if (convertedToUpperCase.includes("DROP") || convertedToUpperCase.includes("DELETE") || convertedToUpperCase.includes("TRUNCATE")) {
            alert("This query is not allowed here.");
            return;
        } else if (convertedToUpperCase.includes(";")) {
            event.preventDefault();
            alert("; character not allowed");
            return;
        } else if (convertedToUpperCase.includes("INSERT") || convertedToUpperCase.includes("UPDATE") || convertedToUpperCase.includes("ALTER") || convertedToUpperCase.includes("RENAME")) {
            event.preventDefault();
            $('#otpPopupP1').modal('show');
            return;
        } 

        
        $.ajax({
            type: 'POST', // Or 'GET', depending on your backend route
            url: '/Authmis/executeQueryTest', // Replace with your backend route
            data: {
                UUID: uuid,
                queryString: queryString
            },
            dataType: 'json',
            success: function(response) {
				$('#resultTable').html('');
                const newHeaders = [];
                response.columns.forEach(function (columnName) {
                	  var th = $('<th>' + columnName + '</th>');
                	  newHeaders.push(th);
                	});
           	$('#resultTable thead tr').append(newHeaders);
           
   			if(table){
				table.destroy();
			}
			const columns = response.columns.map(function (columnName) {
             	  return { data: columnName, title: columnName };
             	});
			$('#resultTable thead tr').html('');
              table =  	  $('#resultTable').DataTable({columns: columns}); 	
              table.rows.add(response.data).draw();
            },
            error: function(xhr, status, error) {
            	$('#throwError').modal('show');
                console.log('Error: ' + error);
            }
        });
    });

    // Your other code...
    

    	/* $(".close").click(function() {
				$('#QueryLogs').modal('hide');
			});

		 $(".QueryLogs").click(function() {
				$('#QueryLogs').modal('show');
			}); */
                 
    	$(".closeModel1").click(function() {
				$('#throwError').modal('hide');
			});

	    $("#generateOTP").click(function(e) {
	        e.preventDefault(); // Prevent the default behavior of the button
	        // Hide the "Generate OTP" button and the Aadhaar input
	        $("#generateOTP, #aadhaar").hide();

	        // Show the OTP input and "Submit OTP" button
	        $("#otpFields, #submitOTP").show();

	        // Generate the initial OTP and start the timer
	        generateOTP();
	    });

	    $("#regenerateOTP").click(function() {
	        $("#regenerateOTP").hide();
	        generateOTP();
	        $("#generateOTP, #aadhaar").hide();

	        // Show the OTP input and "Submit OTP" button
	        $("#otpFields, #submitOTP").show();
	    });

	    $("#submitOTP").click(function() {
	    	
	        var enteredOTP = $("#otp").val();
	        if (enteredOTP === "123456") {
	            // Valid OTP, close the modal
	            clearInterval(otpTimer);
	            $("#generateOTP, #aadhaar").show(); 
		        $("#otpFields, #submitOTP").hide();
		        $("#regenerateOTP").hide();
	            $("#otpModal").modal("hide");
	        } else {
	            // Invalid OTP, show an error message or take action
	            alert("Invalid OTP. Please try again.");
	        }

	    });


	</script>
	
	<!-- FOR LOG TABLE -->
	<script type="text/javascript">
		var table = '';
		$(document)
				.ready(
						function() {
							debugger;

							table1 = $('#table5')
									.DataTable(
											{
												"pageLength" : 10,
												responsive : true,
												lengthMenu : [
														[ 50, 100, 200, 500, -1 ],
														[ 50, 100, 200, 500,
																'All' ], ],

												dom : 'Bfrtip',
												buttons : [ 'pageLength',
														'csv', 'excel' ],

												fixedHeader : {
													header : true,
													footer : true,
												},

											});

							$('.QueryLogs')
									.click(
											function() {
												debugger;
												showLoader();
												$
														.ajax({
															url : "/Authmis/getQueryBuilderLogReport",
															dataType : 'json',
															type : 'GET',
															success : function(
																	data) {
																hideLoader();
																var res = '';
																table1.rows
																		.add([])
																		.clear()
																		.draw();
																table1.rows.add(
																		data)
																		.draw();

																$('#QueryLogs').modal('show');
															},
															fail : function() {
																hideLoader();
																alert("failed");
															}
														});
											})
							$(".close").click(function() {

								$('#QueryLogs').modal('hide');
							});

							function showLoader() {
								$("#loader").show();
							}

							function hideLoader() {
								$("#loader").hide();
							}

						});
	</script>

<script>
		$(document).ready(function() {
			 $(".openModel").click(() => {
				 var approvalDateInput = $("#ApprovalDate");
				
				 if(querys.val === ""){
					 alert("Please Enter a valid Query");
						event.preventDefault();
					 }
				 else {
					 $('#otpPopupP1').modal('show');
				 }
				
			 });
			
			$(".close").click(function() {
				$('#otpPopupP1').modal('hide');
				 $("#otp").hide();
				$("#resentOTP").hide();
				$("#OTPvalidatebtn").hide();
				$("#sendOTP1").show();
				$(".left10minutes").hide();
				$(".opt2minutes").hide();
				var checkbox = $("#agree1");
				if (checkbox.length > 0) {
					if (checkbox.is(":checked")) {
						checkbox.prop("checked", false);
						$('#sendOTP1').prop('disabled', true);
					}
				}
			});
			
			
			
			$(".closeModel").click(function() {
				$('#optverifedsuccessfully').modal('hide');
				location.reload();
			});
			
			$(".cancel").click(function() {
				var checkbox = $("#agree1");
				$("#otp").hide();
				$("#resentOTP").hide();
				$("#OTPvalidatebtn").hide();
				$("#sendOTP1").show();
				$(".left10minutes").hide();
				$(".opt2minutes").hide();
				$("#agree1").prop("disabled", false);
				if (checkbox.length > 0) {
					if (checkbox.is(":checked")) {
						checkbox.prop("checked", false);
						 $('#sendOTP1').prop('disabled', true);
					}
				}
				$('#otpPopupP1').modal('hide');
			});
			
			 $('#agree1').click(function () {
				 
		            if ($(this).is(':checked')) {
		                $('#sendOTP1').prop('disabled', false);
		            }
		            else {
		                $('#sendOTP1').prop('disabled', true);
		            }
		        });
		        // send otp show box
		        $('#sendOTP1').click(function () {
		        	event.preventDefault();
		        	generateOTP();
		        	 $("#otp").show();
		             $("#resentOTP").show();
		             $("#OTPvalidatebtn").show();
		             $("#sendOTP1").hide();
		             $(".left10minutes").show();
		             $(".opt2minutes").show();
		             $("#agree1").prop("disabled", true);
		             startOTPTimer();
		             
		        });
		        //Resend OTP
		        $('#resentOTP').click(function () {
		        	event.preventDefault();
		        	generateOTP();
		        	

		        });
		        
		        
		        $('#OTPvalidatebtn').click(function () {
		        	debugger;
					var otpValue = $("#otp").val();
					if (otpValue === "" || !$.isNumeric(otpValue)) {
						alert("Please enter a valid number OTP.");
					} else {
						event.preventDefault();
		        	validateOtp();
					}
		        	
		        	
		        });
		        
		     		        
		        function generateOTP() {
			    	debugger;
			    	var uuid = $("#exampleModalLongTitle").attr("value");;
			    	$.ajax({
			            type: 'GET', 
			            url: '/Authmis/otpGeneration?UUID=' + uuid, 
			            success: function(response) {
			                var newOTP = response.otp; 
			                $("#otp").val(newOTP);
			                startOTPTimer();
			                alert('OTP sent Successfully');
			            },
			            error: function(xhr, status, error) {
			            	var checkbox = $("#agree1");
							$("#otp").hide();
							$("#resentOTP").hide();
							$("#OTPvalidatebtn").hide();
							$("#sendOTP1").show();
							$(".left10minutes").hide();
							$(".opt2minutes").hide();
							$("#agree1").prop("disabled", false);
							if (checkbox.length > 0) {
								if (checkbox.is(":checked")) {
									checkbox.prop("checked", false);
									 $('#sendOTP1').prop('disabled', true);
								}
							}
			            	$('#otpPopupP1').modal('hide');
			            	alert('Error: Uable to sent OTP');
			            	
			                console.log('Error: ' + error);
			            }
			        });
			 
			    }
		        
			    var otpTimer;
			    var timerDuration = 2 * 60; // 2 minutes
			    
			    function startOTPTimer() {
			        var timerDisplay = $('.otp-countdown');
			        var remainingTime = timerDuration;
			        otpTimer = setInterval(function() {
			            var minutes = Math.floor(remainingTime / 60);
			            var seconds = remainingTime % 60;
			            var display = (minutes < 10 ? '0' : '') + minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
			            timerDisplay.text(display);
			            remainingTime--;

			            if (remainingTime < 0) {
			                clearInterval(otpTimer);
			                $("#regenerateOTP").show();
			                $("#otpFields, #submitOTP").hide();
			            }
			        }, 1000);
			    }
			    
		 function validateOtp() {
				  debugger;
						var formData = {
							otp: $("#otp").val(),
							uuid: $('#exampleModalLongTitle').attr("value"),
							querys: $('.quryString').val(),
							
							
						};
					$.ajax({
						url: '/Authmis/otpAuthenticationForQueryBuilder', // Replace with the actual URL 
						method: 'POST',
						data: JSON.stringify(formData), // Convert the object to JSON
						contentType: 'application/json', // Set the content type
						success: function (response) {
							$('#otpPopupP1').modal('hide');
							$('#optverifedsuccessfully').modal('show');
						},
						 error: function (xhr, status, error) {
					         debugger; 
					         if (xhr.responseText === 'OTP is Not Valid.'){
					            	alert('OTP is Not Valid.');
					            }
					         else {
					                alert(xhr.responseText); // Display the error message received from the server
					                $("#otpPopupP1").hide();
					                $('.modal-backdrop').hide();
					                location.reload();
					            } 
							
					        }
					});
				};
				reader.onerror = function (error) {
					console.log('Error: ', error);
				};
				// Read the file as a Data URL
				reader.readAsDataURL(file);
			});
	
	</script>

<script>
	 function BindClickEventDynamic() {
	        //$.noConflict();
	        $("#btnForward").click(function () {
	            $('#otpPopupP1').modal('show');
	        });
	        $('#agree1').click(function () {
	            if ($(this).is(':checked')) {
	                $('#sendOTP1').prop('disabled', false);
	            }
	            else {
	                $('#sendOTP1').prop('disabled', true);
	            }
	        });
	        // send otp show box
	        $('#sendOTP1').click(function () {
	        	generateOTP()
	        });
	        //Resend OTP
	        $('#resentOTP').click(function () {
	        	generateOTP()
	        });
	        // Verify Otp
	        $('#OTPvalidatebtn').click(function () {
	            VerifyOTP();
	        });
	        //// -------- coundown-timer-----
	        if ($('#timer-countdown').length) {

	            countdown("timer-countdown", 2, 0);
	        }
	    }
	 
	 var element, endTime, hours, mins, msLeft, time;
	    function countdown(elementName, minutes, seconds) {

	        element = document.getElementById(elementName);
	        endTime = (+new Date) + 1000 * (60 * minutes + seconds) + 500;

	        updateTimer();
	    }
	    function twoDigits(n) {
	        return (n <= 9 ? "0" + n : n);
	    }
	    function updateTimer() {
	        msLeft = endTime - (+new Date);
	        if (msLeft < 1000) {
	            element.innerHTML = "Time is up!";
	            $('#resentOTP').show();
	        } else {
	            time = new Date(msLeft);
	            hours = time.getUTCHours();
	            mins = time.getUTCMinutes();
	            element.innerHTML = (hours ? hours + ':' + twoDigits(mins) : mins) + ':' + twoDigits(time.getUTCSeconds());
	            setTimeout(updateTimer, time.getUTCMilliseconds() + 500);
	        }
	    }
	    </script>


</html>